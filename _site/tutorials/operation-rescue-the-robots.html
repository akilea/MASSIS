<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Operation: Rescue the robots. Part 1 &middot; MASSIS
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/massis.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-massis">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/"><img src="http://i.imgur.com/SyxoguR.png" alt="MASSIS"></a>
      </h1>
      <p class="lead">A Framework for MultiAgent System Simulation of Indoor Scenarios</p>
    </div>

    <nav class="sidebar-nav">
      

      

      
      
        <a class="sidebar-nav-item" href="/">Home </a>
      
        <a class="sidebar-nav-item" href="/getting-started.html">Getting started </a>
      
        <a class="sidebar-nav-item" href="/tutorials/">Tutorials </a>
      


      <a class="sidebar-nav-item" href="https://github.com/rpax/MASSIS">GitHub project</a>
      <a class="sidebar-nav-item" href="/contact.html">Contact</a>
<!--      <span class="sidebar-nav-item">Currently v1.2.10</span>
-->
    </nav>

    <p>
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">MASSIS</span> by <span xmlns:cc="http://creativecommons.org/ns#" property="cc:attributionName">Rafael Pax & Juan Pav√≥n (UCM GRASIA)</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
 </p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Operation: Rescue the robots. Part 1</h1>
  <p>It is assumed in this tutorial that the reader has already gone through the basic tutorials, such as <a href="/getting-started.html">the Getting started</a> and <a href="/tutorials/01-sample-massis-application.html">Creating a MASSIS Project</a> sections have been already been read.</p>

<p>For designing the scenario, it is also recommended to read the <a href="/tutorials/04-bigger-environment-and-multiple-agents.html">environment design</a> section.</p>

<h2 id="scenario-description">Scenario description</h2>

<p>The impact of a meteorite has caused irreparable damage to an extraterrestrial station. Luckily, there were no humans on the station, only robots.</p>

<p>But these robots were controlled remotely, and the meteorite impact has broken one antenna. In order to solve this issue, a new kind of robots are sent to this station. Their mission will consist on rescuing the robots that are in the incommunicated station, by finding  and taking them to the landing zone of the station.</p>

<p>The file with the description of this extraterrestrial station for this tutorial can be downloaded <a href="https://drive.google.com/open?id=0B3-oRpDTDan3Z3dRQmVXalBYYkU">from here</a>. When opening this should look something like this figure:</p>

<p><img src="http://i.imgur.com/tRexsTw.png" alt="Scenario"></p>

<p>There are two kinds of robots, those that  were in the station (workers), and those that have arrived to rescue them (rescuers). Their behaviour, in this case of incommunication of the station, is the following:</p>

<ul>
<li><strong>Worker</strong> robot behavior

<ol>
<li>Wait  until someone tells it what target should be following.</li>
</ol></li>
<li><strong>Rescuer</strong> robot behavior

<ol>
<li>Try to visit all the rooms in the building. Whenever this robot sees a worker robot in the room, requests that worker robot to follow it.</li>
<li>When two (or more) <em>rescuer</em> robots are in the same room, they share information about the rooms visited.</li>
<li>When all the rooms have been explored, the robot goes back to the <em>landing zone</em></li>
</ol></li>
</ul>

<h2 id="implementation-from-the-idea-to-the-code">Implementation - From the idea to the code</h2>

<p>This project will be based on the  <a href="/tutorials/01-sample-massis-application.html">basic MASSIS archetype explained previously</a>.</p>

<h3 id="two-behaviors-imply-two-classes">Two behaviors imply two classes.</h3>

<p>Each behavior should be modeled as a Java class. In this scenario, we have two different behaviors, the <em>Worker</em> behavior and the <em>Rescuer</em> behavior.</p>

<p>The <em>Worker</em> behavior is fairly simple: Just a translation of the behavior definition:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">package com.myawesomesimulator.ai;

import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

import com.massisframework.massis.model.agents.HighLevelController;
import com.massisframework.massis.model.agents.LowLevelAgent;
import com.massisframework.massis.model.managers.movement.ApproachCallback;
import com.massisframework.massis.pathfinding.straightedge.FindPathResult.PathFinderErrorReason;

public class WorkerController extends HighLevelController {

  private static final long serialVersionUID = 1L;

  private LowLevelAgent followTarget;

  public WorkerController(LowLevelAgent agent, Map&lt;String, String&gt; metadata,
      String resourcesFolder) {
    super(agent, metadata, resourcesFolder);
    this.agent.setHighLevelData(this);
  }

  @Override
  public void stop() {

  }

  @Override
  public void step() {
    if (this.followTarget != null) {
      this.agent.approachTo(this.followTarget.getLocation(),
        new ApproachCallback() {

          @Override
          public void onTargetReached(LowLevelAgent agent) {
            // Nothing. We are going to follow the target forever.

          }

          @Override
          public void onSucess(LowLevelAgent agent) {
            // Continue following the target.
          }

          @Override
          public void onPathFinderError(PathFinderErrorReason reason) {
            Logger.getLogger(WorkerController.class.getName()).log(
                Level.SEVERE,
                &quot;An error occurred when approaching to {0}. Reason: {1}&quot;,
                new Object[] { followTarget.getLocation(), reason });

          }
        });
    }
  }

  public void setFollowTarget(LowLevelAgent agent) {
    this.followTarget = agent;
  }

  public boolean isFollowingSomeone() {
    return this.followTarget != null;
  }
}
</code></pre></div>
<p>That is! Simple, huh?</p>

<p>The <em>Rescuer</em> behavior is a little more tricky. Let&#39;s split it into parts:</p>

<ul>
<li><em>Tries to visit all the rooms in the building.</em>

<ul>
<li>This imply that the robot should track the rooms that it has visited.</li>
</ul></li>
<li><em>Whenever this robot sees a worker robot in the room, makes that worker robot to follow him.</em>

<ul>
<li>We need some type of gathering information about the current room.</li>
</ul></li>
<li><em>When two (or more) rescuer robots are in the same room, they share information about the rooms visited.</em>

<ul>
<li>This can be accomplished interchanging the visited rooms of each robot.</li>
</ul></li>
<li><em>When all the rooms have been explored, this robot goes back to the landing zone</em>

<ul>
<li>This is just a basic operation.</li>
</ul></li>
</ul>

<p>With this facts identified, the only thing left is to code them in a <code>HighLevelController</code>.
As we have created the project using the archetype, designing the behavior becomes a <em>fill in the gaps</em> exercise.
The attributes needed should be the unexplored rooms, the next room to visit and (optional, but useful in this case) if the work has finished or not.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">private Collection&lt;SimRoom&gt; roomsUnexplored;
private SimRoom assignedRoom;
private boolean workFinished;
</code></pre></div>
<p>In the constructor we should initialize the unexplored rooms, and setting the <code>workFinished</code> attribute to false.
<code>
public RescuerController(LowLevelAgent agent, Map&lt;String, String&gt; metadata,
        String resourcesFolder) {
    super(agent, metadata, resourcesFolder);
    this.agent.setHighLevelData(this);
    this.workFinished = false;
    this.roomsUnexplored = new HashSet&lt;&gt;();
    for (SimRoom r : this.agent.getLocation().getFloor().getRooms()) {
        this.roomsUnexplored.add(r);
    }
    this.logger = Logger.getLogger(&quot;Rescuer_&quot; + agent.getID());
    this.assignNewRoomToExplore();
}
</code>
This robot should interchange the information about the rooms with other robots:
<code>
private void shareRoomsWith(RescuerController rescuer) {
    // remove every item that is not present in the other map
    final boolean changed = this.roomsUnexplored
            .retainAll(rescuer.roomsUnexplored);
    if (changed) {
        logger.log(Level.INFO,
                &quot;Updated information about rooms to explore: {0}&quot;,
                this.roomsUnexplored);
    }
}
</code>
This robot should be capable of auto-assigning rooms to explore:
```
private void assignNewRoomToExplore() {
    if (!this.roomsUnexplored.isEmpty()) {
        SimRoom[] rem = this.roomsUnexplored.toArray(new SimRoom[] {});
        this.assignedRoom = rem[ThreadLocalRandom.current()
                .nextInt(rem.length)];
        this.roomsUnexplored.remove(this.assignedRoom);
    }</p>

<p>}
<code>
Also, for approaching to its current target, this method can be written for clarity:
</code>
private void approachToAssignedRoom() {
  this.agent.approachTo(this.assignedRoom.getLocation(),
    new ApproachCallback() {</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    @Override
    public void onTargetReached(LowLevelAgent agent) {
        assignNewRoomToExplore();
    }

    @Override
    public void onSucess(LowLevelAgent agent) {
    }

    @Override
    public void onPathFinderError(
            PathFinderErrorReason reason) {
        logger.log(Level.SEVERE,
                &quot;An error occurred when approaching to room {0} Reason: {1}&quot;,
                new Object[] { reason, assignedRoom.getID() });

    }
});
</code></pre></div>
<p>}
<code>
Finally, for approaching to the _landing zone_,
</code>
private void approachToLandingZone() {
    if (!this.workFinished) {
        this.agent.approachToNamedLocation(&quot;LANDING_ZONE&quot;,
            new ApproachCallback() {
                @Override
                public void onTargetReached(LowLevelAgent agent) {
                    // Work finished.
                    RescuerController.this.workFinished = true;
                }
                @Override
                public void onSucess(LowLevelAgent agent) {
                }
                @Override
                public void onPathFinderError(
                        PathFinderErrorReason reason) {
                    logger.log(Level.SEVERE,
                            &quot;An error occurred when approaching &quot;
                                    + &quot;to landing zone. Reason: {0}&quot;,
                            reason);</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">            }
        });
}
</code></pre></div>
<p>}
```</p>

<p>This utility methods are intended for using them in the <code>step()</code> method:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">@Override
public void step() {
    /*
     * Is anybody in the room?
     */
    if (!this.roomsUnexplored.isEmpty()) {
        /*
         * For each agent found in the room, do the corresponding task
         */
        for (LowLevelAgent otherAgent : this.agent.getAgentsInRoom()) {
            // avoid self
            if (this.agent == otherAgent)
                continue;
            /*
             * Is a rescuer?
             */
            if (otherAgent
                    .getHighLevelData() instanceof RescuerController) {
                /*
                 * Affirmative. Share room information
                 */
                shareRoomsWith(
                        (RescuerController) otherAgent.getHighLevelData());
                /*
                 * Is a worker? follow me.
                 */
            } else if (otherAgent
                    .getHighLevelData() instanceof WorkerController) {

                final WorkerController follower = (WorkerController) otherAgent
                        .getHighLevelData();
                /*
                 * Check if the robot is already following someone
                 */
                if (!follower.isFollowingSomeone()) {
                    follower.setFollowTarget(this.agent);
                }
            }

        }
        this.approachToAssignedRoom();

    } else {
        // Go to landing zone.
        this.approachToLandingZone();
    }
}
</code></pre></div>
<h1 id="conclusion">Conclusion</h1>

<p>That&#39;s everything! If you prefer to download the entire project, with the building included, <a href="https://drive.google.com/open?id=0B3-oRpDTDan3Nl9pdUdDRUY0cDQ">you can do it from here</a></p>

</div>

<!--<div class="pagination">
  
    <span class="pagination-item newer">Previous</span>
  

  
    <span class="pagination-item older">Next</span>
  
</div>-->

    </div>
<script>
//dirty fix for making this work under github domain
  var fixLinks=function(els) {
      for(var i =0;i<els.length;i++){
        if (els[i].href.indexOf("github.io")>0 && els[i].href.indexOf("github.io/MASSIS")<1)
          els[i].href=els[i].href.replace("github.io","github.io/MASSIS");
      }
  };
  fixLinks(document.getElementsByTagName("a"));
  fixLinks(document.getElementsByTagName("link"));
</script>
<script>
  // Google analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73066450-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
  
</html>
